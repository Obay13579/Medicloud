name: CI/CD Pipeline

on:
  push:
    # Trigger kalau ada push ke main (Production) atau dev (Staging)
    branches: [ "main", "dev" ]

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Setup Docker Meta untuk handle Tagging otomatis (main -> latest, dev -> dev)
      - name: Docker Meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ${{ secrets.DOCKERHUB_USERNAME }}/medicloud-backend
            ${{ secrets.DOCKERHUB_USERNAME }}/medicloud-frontend
          tags: |
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}

      # Build Backend
      - name: Build and push Backend
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          # Kita filter output tags biar yang backend ambil tag backend aja
          # (Note: metadata-action agak tricky buat monorepo, 
          # cara manual di bawah lebih aman untuk project simple):
          
      # --- CARA MANUAL YANG LEBIH PASTI UNTUK MONOREPO ---
      
      # Backend Build
      - name: Build Backend (Main/Latest)
        if: github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/medicloud-backend:latest

      - name: Build Backend (Dev)
        if: github.ref == 'refs/heads/dev'
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/medicloud-backend:dev

      # Frontend Build
      - name: Build Frontend (Main/Latest)
        if: github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/medicloud-frontend:latest

      - name: Build Frontend (Dev)
        if: github.ref == 'refs/heads/dev'
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/medicloud-frontend:dev
